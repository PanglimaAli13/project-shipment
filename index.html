<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Input Shipment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles untuk tampilan Soft UI */
        .soft-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        }
        .input-field {
            transition: all 0.3s ease;
        }
        /* Perbaikan: Mengganti properti 'ring' dengan CSS standar box-shadow */
        .input-field:focus {
            outline: none; 
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); 
        }
        /* Memastikan tabel dapat di-scroll horizontal pada layar kecil */
        .table-wrapper {
            overflow-x: auto; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-700 font-sans pb-20">

    <div class="max-w-3xl mx-auto px-4 py-8">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-600 tracking-tight">Selamat Datang</h1>
            <p class="text-gray-500 mt-2">Form Input Shipment Harian</p>
        </div>

        <div class="soft-card p-6 mb-6 border border-gray-100">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Nama Driver</label>
                    <select id="driverSelect" class="input-field w-full p-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-700 cursor-pointer">
                        <option value="">-- Pilih Driver --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Tanggal Mulai</label>
                    <input type="date" id="startDate" class="input-field w-full p-3 rounded-xl border border-gray-200 bg-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Tanggal Selesai</label>
                    <input type="date" id="endDate" class="input-field w-full p-3 rounded-xl border border-gray-200 bg-white">
                </div>
            </div>
            
            <button onclick="loadData()" class="w-full mt-6 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-md shadow-indigo-200">
                Tampilkan Data
            </button>
        </div>

        <div id="shipmentSummary" class="text-lg font-semibold text-gray-700 mb-4 hidden">
            Total Shipment dalam Rentang: <span id="shipmentCount" class="text-indigo-600">0</span>
        </div>

        <div id="tableContainer" class="hidden soft-card overflow-hidden border border-gray-100">
            <div class="table-wrapper">
                <table class="w-full text-left border-collapse min-w-[300px]">
                    <thead class="bg-indigo-50 text-indigo-700">
                        <tr>
                            <th class="p-4 font-semibold text-sm uppercase tracking-wider w-1/3">Tanggal</th>
                            <th class="p-4 font-semibold text-sm uppercase tracking-wider">Shipment (10 Digit)</th>
                            <th class="p-4 font-semibold text-sm text-center w-16">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="shipmentTableBody" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
        <div class="bg-white soft-card p-6 w-80 text-center transition-all duration-300">
            <svg class="w-12 h-12 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Penyimpanan Berhasil!</h3>
            <p class="text-sm text-gray-500 mb-4">Data shipment untuk tanggal ini telah diperbarui.</p>
            <button onclick="closeModal('successModal')" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl transition duration-300">
                OK
            </button>
        </div>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
        <div class="bg-white soft-card p-6 w-80 text-center transition-all duration-300">
            <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Validasi Gagal!</h3>
            <p class="text-sm text-gray-500 mb-4">**Shipment Code** wajib 10 digit angka. Jika kosong, biarkan input field kosong lalu Simpan.</p>
            <button onclick="closeModal('errorModal')" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-xl transition duration-300">
                Tutup
            </button>
        </div>
    </div>

    <script>
        // GANTI 'project-shipment.vercel.app' DENGAN URL VERCEL PROYEK ANDA YANG ASLI
        const API_URL_BASE = 'https://project-shipment.vercel.app'; 
        
        // Fungsi utilitas untuk membuka dan menutup modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // ==========================================================
        // !!! FUNGSI UNTUK PENGHITUNGAN SHIPMENT !!!
        // ==========================================================
        
        function getShipmentCount() {
            const shipmentInputs = document.querySelectorAll('[id^="shipment_"]');
            let count = 0;
            shipmentInputs.forEach(input => {
                const value = input.value.trim();
                if (value.length === 10) {
                    count++;
                }
            });
            return count;
        }

        function updateShipmentCount() {
            const count = getShipmentCount();
            document.getElementById('shipmentCount').textContent = count;
            document.getElementById('shipmentSummary').classList.remove('hidden');
        }
        
        // 1. Load Drivers saat halaman dibuka
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // API dipanggil ke /api/drivers (yang ditangani oleh Serverless Function)
                const res = await fetch(`${API_URL_BASE}/api/drivers`);
                const drivers = await res.json();

                if (res.status !== 200) {
                     // Menangani error jika serverless function bermasalah
                     alert('Gagal memuat data driver. Cek Variable Lingkungan DATABASE_URL di Vercel.');
                     return;
                }

                const select = document.getElementById('driverSelect');
                drivers.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.nik_driver;
                    opt.textContent = `${d.nama_driver} (${d.nik_driver})`;
                    opt.dataset.nama = d.nama_driver;
                    select.appendChild(opt);
                });
            } catch (e) { 
                console.error(e);
                alert('Terjadi kesalahan koneksi ke API. Pastikan Serverless Functions sudah di-deploy.');
            }
        });

        // 2. Fungsi Utama: Load Data & Generate Table (Optimized)
        async function loadData() {
            const select = document.getElementById('driverSelect');
            const nik = select.value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const nama_driver = select.options[select.selectedIndex].dataset.nama;

            if (!nik || !start || !end) {
                alert("Mohon lengkapi Driver dan Rentang Tanggal");
                return;
            }

            // Ambil data existing dari DB
            let existingData = [];
            try {
                // API dipanggil ke /api/shipments (GET)
                const res = await fetch(`${API_URL_BASE}/api/shipments?nik=${nik}&startDate=${start}&endDate=${end}`);
                existingData = await res.json();
            } catch (e) {
                console.error(e);
                alert('Gagal mengambil data shipment dari API.');
                return;
            }

            let tableHTML = '';
            
            // Perbaikan Logika Tanggal (Zona Waktu Lokal)
            let currDate = new Date(start + 'T00:00:00');
            const lastDate = new Date(end + 'T00:00:00');

            while (currDate <= lastDate) {
                const dateStrISO = currDate.toISOString().split('T')[0]; 
                const dateStrDisplay = currDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const isSunday = currDate.getDay() === 0;

                const foundData = existingData.find(d => d.tanggal && d.tanggal.startsWith(dateStrISO));
                const shipmentValue = (foundData && foundData.shipment_code !== '-') ? foundData.shipment_code : '';
                const placeholder = shipmentValue ? shipmentValue : '-';

                const rowClass = `border-b border-gray-100 hover:bg-gray-50 transition ${isSunday ? 'bg-red-50' : ''}`;
                const dateClass = `${isSunday ? 'text-red-600 font-bold' : 'text-gray-600'}`;
                const inputClass = `w-full p-2 rounded-lg border text-sm ${isSunday ? 'border-red-200 bg-white' : 'border-gray-300 bg-white'} focus:border-indigo-500 focus:ring-2 focus:ring-2 focus:ring-indigo-200 outline-none transition`;

                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="p-4 ${dateClass}">
                            ${dateStrDisplay} ${isSunday ? '<span class="text-xs block text-red-400">(Minggu)</span>' : ''}
                        </td>
                        <td class="p-4">
                            <input type="text" 
                                id="shipment_${dateStrISO}"
                                value="${shipmentValue}" 
                                placeholder="${placeholder}" 
                                maxlength="10"
                                oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateShipmentCount()"
                                class="${inputClass}"
                            >
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="saveShipment('${dateStrISO}')" class="text-indigo-500 hover:text-indigo-700 font-medium text-sm">
                                Simpan
                            </button>
                        </td>
                    </tr>
                `;

                currDate.setDate(currDate.getDate() + 1);
            }

            const tbody = document.getElementById('shipmentTableBody');
            tbody.innerHTML = tableHTML;
            document.getElementById('tableContainer').classList.remove('hidden');

            // Panggil fungsi penghitungan setelah tabel dimuat
            updateShipmentCount();
        }

        // 3. Fungsi Simpan Per Baris
        async function saveShipment(dateISO) {
            const select = document.getElementById('driverSelect');
            const nik_driver = select.value;
            const nama_driver = select.options[select.selectedIndex].dataset.nama;
            const shipmentInput = document.getElementById(`shipment_${dateISO}`);
            const shipment_code = shipmentInput.value.trim();

            // VALIDASI
            if (shipment_code.length > 0 && shipment_code.length !== 10) {
                openModal('errorModal');
                shipmentInput.focus();
                return;
            }

            const final_shipment_code = shipment_code === '' ? '-' : shipment_code;

            try {
                // API dipanggil ke /api/shipments (POST)
                const res = await fetch(`${API_URL_BASE}/api/shipments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nik_driver,
                        nama_driver,
                        tanggal: dateISO,
                        shipment_code: final_shipment_code
                    })
                });

                if (res.ok) {
                    if (final_shipment_code === '-') {
                         shipmentInput.value = ''; 
                         shipmentInput.placeholder = '-';
                    }
                    
                    openModal('successModal');
                    
                    shipmentInput.classList.add('border-green-500', 'ring-2', 'ring-green-200');
                    setTimeout(() => shipmentInput.classList.remove('border-green-500', 'ring-2', 'ring-green-200'), 1500);

                    // Panggil fungsi penghitungan ulang
                    updateShipmentCount();

                } else {
                    alert('Gagal menyimpan. Cek konsol browser dan server.');
                }
            } catch (e) {
                console.error('Terjadi kesalahan koneksi:', e);
                alert('Terjadi kesalahan koneksi ke API.');
            }
        }
    </script>
</body>
</html>